<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>司法試験 論証タイピング</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
  <meta name="theme-color" content="#0e2240">
  <!-- Chart.jsライブラリの読み込み -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ==================================================
       HOSHINO-INSPIRED THEME (Navy × Gold × Ivory) - BASE
       ================================================== */
    :root{
      --bg:#f7f5ef;         /* ivory */
      --panel:#ffffff;
      --ink:#161a24;        /* deep ink */
      --ink-2:#4b5563;      /* muted */
      --line:#e6e0d4;       /* warm line */
      --accent:#0e2240;     /* deep navy */
      --accent-2:#b4883b;   /* warm gold */
      --accent-soft:#eef2f8;
      --radius-lg:14px;
      --radius-md:10px;
      --shadow-md:0 12px 40px rgba(10,17,30,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                   "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Source Han Sans JP", "Yu Gothic",
                   Meiryo, Arial, sans-serif;
      color:var(--ink); background:var(--bg); letter-spacing:.01em;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    h1,h2,h3{
      font-family: "Hiragino Mincho ProN", "Yu Mincho", "Noto Serif JP", "Source Han Serif JP",
                   Georgia, "Times New Roman", serif;
      font-weight:700; letter-spacing:.02em;
    }
    h2{ font-size:1.1rem; margin:.1rem 0 .6rem 0; font-weight:900 }
    h3{ font-size:1rem; margin:.2rem 0 .4rem 0; font-weight:800; color:var(--ink) }
    small,.muted{font-size:.84rem; color:var(--ink-2); letter-spacing:.01em}
    .container, main, #app, .page{max-width:1080px; margin:0 auto; padding:12px}
    .section{margin-top:1rem}
    .card{
      background:linear-gradient(180deg, #fff 0%, #fffdf9 100%);
      border:1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding:1rem;
    }
    .list-item{
      border:1px solid var(--line); border-radius:12px; background:#fff; padding:.9rem;
    }
    /* Controls */
    button{
      line-height:1; border-radius:var(--radius-md);
      font-weight:600;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }
    button:hover { 
      filter: brightness(1.05);
      transform: translateY(-1px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: none;
      transform: none;
    }
    button.primary{
      height:42px; padding:0 1rem; font-weight:700;
      background:linear-gradient(180deg, #143057 0%, #0e2240 100%);
      border:1px solid #0e2240; color:#fff;
    }
    button.primary:hover { filter: brightness(1.1); transform: scale(1.02); }
    button.ghost{
      height:42px; padding:0 .95rem; font-weight:700;
      border:1px solid var(--line); background:#fff;
    }
    button.ghost:hover{ border-color:#d9cfbf; background-color: #fcfcfc; }
    .badge{ display:inline-flex; align-items:center; justify-content:center; min-width:24px; height:22px; padding:0 .5rem;
      border-radius:999px; background:var(--accent-2); color:#fff; font-weight:600; font-size:.75rem }
    .pill{ display:inline-flex; align-items:center; padding:.22rem .6rem; border:1px solid var(--line); border-radius:999px; background:var(--panel); font-weight:600 }
    /* Inputs */
    input, select, textarea{ width:100%; background:#fff; color:var(--ink); border:1px solid var(--line);
      border-radius:var(--radius-md); padding:.66rem; font:inherit; }
    input:focus, select:focus, textarea:focus{ outline:none; box-shadow:0 0 0 3px rgba(180,136,59,.18); border-color:#c9b58f; }
    textarea{ font-size:16px; line-height:1.55 }

    /* ================== RAIL & TABBAR LAYOUT ================== */
    #rail{
      position:fixed; left:0; top:0; bottom:0; width:240px;
      background:linear-gradient(180deg,#0e2240 0%, #0a1830 100%); color:#eaf2ff;
      border-right:1px solid rgba(255,255,255,.08);
      display:none; flex-direction:column; padding:16px 14px; gap:10px; z-index:49;
    }
    #rail .logo{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.02em; color:#fff; }
    #rail .logo .mon{ width:30px; height:30px; border-radius:999px; background:#b4883b; color:#0e2240;
      display:inline-flex; align-items:center; justify-content:center; font-weight:900 }
    #rail .nav{ display:flex; flex-direction:column; gap:8px; margin-top:10px }
    #rail .nav button{
      display:flex; align-items:center; gap:10px;
      height:40px; padding:0 12px; font-size:.95rem; border-radius:10px;
      background:transparent; color:#eaf2ff; border:1px solid rgba(255,255,255,.08);
      font-weight:800; cursor:pointer;
    }
    #rail .nav button:hover{ background:rgba(255,255,255,.06) }
    #rail .nav button.active{ background:#b4883b; color:#0e2240; border-color:#b4883b }
    #rail .spacer{ flex:1 }
    #rail .mode{ border-top:1px solid rgba(255,255,255,.08); padding-top:10px; display:grid; gap:8px }
    #rail .mode .seg{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
    #rail .mode .seg button{ height:34px; font-size:.9rem; border-radius:9px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); color:#fff; font-weight:900 }
    #rail .mode .seg button.active{ background:#fff; color:#0e2240 }

    #tabbar{
      position:fixed; left:0; right:0; bottom:0; height:60px; background:#0e2240; color:#eaf2ff;
      border-top:1px solid rgba(255,255,255,.08); display:none; align-items:center; justify-content:space-around; z-index:60;
    }
    #tabbar .item{ display:flex; flex-direction:column; gap:2px; align-items:center; justify-content:center; width:20% }
    #tabbar .item button{ background:transparent; border:0; color:#eaf2ff; font-size:.8rem; font-weight:700 }
    #tabbar .item .ico{ width:20px; height:20px; opacity:.9 }
    #tabbar .item.active button{ color:#fff }
    #tabbar .item.active .ico{ opacity:1 }
    #mode-fab{
      position:fixed; right:12px; bottom:72px; width:46px; height:46px; border-radius:999px;
      background:#b4883b; color:#0e2240; display:none; align-items:center; justify-content:center; font-weight:900; z-index:61;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
    }
    @media(min-width: 1000px){
      #rail{ display:flex }
      body{ padding-left:240px }
    }
    @media(max-width: 999px){
      #tabbar{ display:flex }
      #mode-fab{ display:flex }
      body{ padding-bottom:68px }
    }
    
    /* iPhone specific styles */
    html.iphone #tabbar .item[data-nav="exit"]{ display:flex !important; }
    html.iphone #iphone-exit{ display:flex; }
    html.iphone:not(.subjects-active) #iphone-exit{ display:none !important; }
    #iphone-exit{
      position:fixed; right:12px; top:calc(env(safe-area-inset-top, 0px) + 8px);
      width:46px; height:46px; border-radius:999px;
      display:none; align-items:center; justify-content:center;
      background:#b4883b; color:#0e2240; font-weight:900; font-size:16px;
      border:0; box-shadow:0 8px 24px rgba(0,0,0,.18); z-index:70;
    }

    /* Helper classes */
    .flex{display:flex; gap:.6rem; align-items:center; flex-wrap:wrap}
    .row-sm{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .space{flex:1 1 auto}
    .hidden{display:none}

    /* Error overlay */
    #errlayer{position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;z-index:9999;display:none;align-items:center;justify-content:center;padding:1rem}
    #errbox{background:#111;border:1px solid #444;max-width:900px;width:100%;padding:1rem;border-radius:.75rem}
    #errbox pre{white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.85rem;background:#000;padding:.75rem;border-radius:.5rem;color:#0f0;max-height:50vh;overflow:auto}
  
    /* Modal */
    #modal-root .mask{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:1000}
    #modal-root .modal{background:var(--panel,#fff);color:var(--ink,#111);width:min(680px,96vw);max-height:85vh;overflow:auto;border-radius:12px;padding:1rem;box-shadow:0 10px 40px rgba(0,0,0,.2)}

    /* Misc */
    mark.hit{background:#fde68a}
    mark.miss, .kw-miss, .highlight-miss{
      background:#ffd5e5 !important; color:inherit; border-radius:4px;
      box-shadow:0 0 0 1px rgba(255, 105, 180, .15) inset;
    }
    .cloze-card .cloze-slot{padding:0 3px;border-bottom:2px dotted #999;cursor:pointer;border-radius:4px;transition:background .15s, border-color .15s}
    .cloze-card .cloze-slot.ok{background:rgba(46,204,113,.18);border-bottom-color:#2ecc71}
    .cloze-card .cloze-slot.miss{background:rgba(255,64,129,.14);border-bottom-color:#ff4081}
    .cloze-card .cloze-slot.empty{background:rgba(0,0,0,.06);border-bottom-color:#bbb}
    .cloze-inputs{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.5rem}
    .cloze-inputs input.ok{outline:2px solid #2ecc71}
    .cloze-inputs input.miss{outline:2px solid #ff4081}
    #rail .nav button[data-nav="exit"]{ display:none !important; }
    #tabbar .item[data-nav="exit"]{ display:none !important; }

    /* ===== NEW 2025 DESIGN REFRESH & HOME SCREEN ===== */
    :root {
      --font-sans: "SF Pro Text", "Hiragino Kaku Gothic ProN", "Noto Sans JP", ui-sans-serif, system-ui, -apple-system, sans-serif;
      --font-serif: "Hiragino Mincho ProN", "Noto Serif JP", serif;
      --radius-xl: 16px;
      --shadow-lg: 0 20px 50px -12px rgba(10, 17, 30, .12);
    }
    /* カードデザインの改良 */
    .card {
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(230, 224, 212, 0.8);
    }
    /* ボタンとインタラクティブ要素の改良 */
    .list-item, .review-row {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .list-item:hover, .review-row:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: #d9cfbf;
    }
    /* --- 新しいホーム画面のスタイル --- */
    .home-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
    }
    .stat-card {
      background: linear-gradient(180deg, #fff 0%, #fffdf9 100%);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      box-shadow: var(--shadow-md);
    }
    .stat-card .value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }
    .stat-card .value .unit {
      font-size: 1rem;
      font-weight: 600;
      color: var(--ink-2);
      margin-left: 0.25rem;
    }
    .stat-card .label {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--ink-2);
    }
    
    /* --- 科目別統計のスタイル --- */
    .subject-stats-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .subject-stat-item {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
    }
    .subject-stat-item .subject-name {
      font-weight: 800;
      color: var(--ink);
    }
    .stat-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }
    .stat-row .label {
      font-size: 0.8rem;
      color: var(--ink-2);
      width: 4.5em;
    }
    .stat-row .value {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--ink);
      width: 3em;
    }
    .progress-bar-container {
      flex: 1;
      background-color: #eef2f8;
      border-radius: 999px;
      height: 8px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      border-radius: 999px;
      background-color: var(--accent-2);
      transition: width 0.5s ease-in-out;
    }
    
    /* --- 検索ページのスタイル --- */
    #search-results {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    /* --- トースト通知のスタイル --- */
    #toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      padding: 12px 20px;
      border-radius: var(--radius-md);
      color: #fff;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      opacity: 0;
      transform: translateY(20px);
      animation: toast-in 0.5s forwards;
    }
    .toast.success { background-color: #16a34a; }
    .toast.info { background-color: var(--accent); }
    @keyframes toast-in {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes toast-out {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(20px);
      }
    }
    
    /* --- 復習ページの新しいスタイル --- */
    .review-tabs {
      display: flex;
      gap: 0.5rem;
      border-bottom: 1px solid var(--line);
      margin-bottom: 1.5rem;
    }
    .review-tab {
      padding: 0.75rem 1rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 700;
      color: var(--ink-2);
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .review-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .action-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .action-card.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .action-card .icon {
      width: 40px;
      height: 40px;
      color: var(--accent-2);
      margin-bottom: 1rem;
    }
    .action-card.primary .icon {
      color: #fff;
    }
    .action-card .title {
      font-size: 1.2rem;
      font-weight: 800;
      margin: 0 0 0.5rem;
    }
    .action-card.primary .title {
      color: #fff;
    }
    .action-card .description {
      font-size: 0.9rem;
      color: var(--ink-2);
      margin: 0 0 1.5rem;
      max-width: 400px;
    }
    .action-card.primary .description {
      color: rgba(255,255,255,0.8);
    }
    .action-card .actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    .review-details-list {
      margin-top: 1rem;
      border-top: 1px solid var(--line);
      padding-top: 1rem;
    }
    .review-detail-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      border-radius: var(--radius-md);
    }
    .review-detail-item:hover {
      background-color: var(--accent-soft);
    }
    .review-detail-item .timing-tag {
      background-color: var(--accent-2);
      color: #fff;
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      font-weight: 700;
      flex-shrink: 0;
    }
  </style>
  <script>
    // Optional: disable SW if ?nosw in URL
    (function(){
      if (location.search.includes('nosw')) {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
        }
        console.log('[SW] Disabled via ?nosw');
      } else if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(err=>console.warn('SW register failed', err));
        });
      }
    })();
  
    /* ===== Input Mode (full/cloze) & Cloze helpers ===== */
    function getInputMode(){
      try{
        if (typeof config!=='undefined' && config && config.inputMode) return config.inputMode;
      }catch(_){}
      try{
        const v = localStorage.getItem('rt_inputMode');
        return (v==='cloze' ? 'cloze' : 'full');
      }catch(_){}
      return 'full';
    }
    function setInputMode(m){
      const mode = (m==='cloze') ? 'cloze' : 'full';
      try{ config.inputMode = mode; }catch(_){}
      try{ localStorage.setItem('rt_inputMode', mode); }catch(_){}
      try{ if (typeof saveConfig==='function') saveConfig(); }catch(_){}
      try{ updateInputModeUI(); }catch(_){}
      try{ render(); }catch(_){}
    }
    window.__setInputMode = setInputMode;

    function updateInputModeUI(){
      try{
        const full=document.getElementById('rail-mode-full');
        const clo=document.getElementById('rail-mode-cloze');
        const mode=getInputMode();
        if(full&&clo){
          full.classList.toggle('active', mode==='full');
          clo.classList.toggle('active', mode==='cloze');
        }
      }catch(_){}
    }
    window.addEventListener('load', ()=>{
      try{
        if (!config.inputMode){
          const v = localStorage.getItem('rt_inputMode');
          if (v) config.inputMode = (v==='cloze'?'cloze':'full');
        }
      }catch(_){}
      try{ updateInputModeUI(); }catch(_){}
    });

    function buildClozeNumbered(text, keywords){
      if (!text || !Array.isArray(keywords) || !keywords.length) return null;
      let out = text;
      const pairs = keywords.map((kw, i)=>({kw: String(kw||''), n: i+1})).filter(x=>x.kw.length>0)
                           .sort((a,b)=> b.kw.length - a.kw.length);
      for (const {kw, n} of pairs){
        const esc = kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        out = out.replace(new RegExp(esc, 'g'), `<span class="cloze-slot" data-slot="${n}" id="slot-${n}">［${n}］</span>`);
      }
      return out!==text ? out : null;
    }
  </script>
</head>

<body>
<aside id="rail" aria-label="メインナビ">
  <div class="logo"><span class="mon">法</span><span>論証タイピング</span></div>
  <div class="nav">
    <button data-nav="home"><svg class="ico" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>ホーム</button>
    <button data-nav="search"><svg class="ico" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>検索</button>
    <button data-nav="subjects"><svg class="ico" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M4 19h16v2H4zM4 3h8a4 4 0 0 1 4 4v10H4z"/><path d="M16 7h4v10h-4z"/></svg>科目</button>
    <button data-nav="review"><svg class="ico" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M3 4h18v2H3zM3 10h18v2H3zM3 16h12v2H3z"/></svg>復習</button>
    <button data-nav="add"><svg class="ico" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>追加</button>
    <button data-nav="settings"><svg class="ico" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19.14 12.94a7.07 7.07 0 0 0 .05-.94 7.07 7.07 0 0 0-.05-.94l2.03-1.58-1.92-3.32-2.4.97a7.34 7.34 0 0 0-1.62-.94l-.36-2.54h-3.84l-.36 2.54c-.57.22-1.12.53-1.62.94l-2.4-.97-1.92 3.32L4.86 11.06c-.03.31-.05.62-.05.94 0 .32.02.63.05.94l-2.03 1.58 1.92 3.32 2.4-.97c.5.41 1.05.72 1.62.94l.36 2.54h3.84l.36-2.54c.57-.22 1.12-.53 1.62-.94l2.4.97 1.92-3.32-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7z"/></svg>設定</button>
    <button data-nav="exit"><svg class="ico" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M10 17l5-5-5-5v10z"/><path d="M4 4h6v2H6v12h4v2H4z"/></svg>終了</button>
  </div>
  <div class="spacer"></div>
  <div class="mode">
    <small>入力モード</small>
    <div class="seg">
      <button id="rail-mode-full">全文</button>
      <button id="rail-mode-cloze">穴埋め</button>
    </div>
  </div>
</aside>

<nav id="tabbar" aria-label="タブバー">
  <div class="item" data-nav="home"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><button>ホーム</button></div>
  <div class="item" data-nav="search"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg><button>検索</button></div>
  <div class="item" data-nav="subjects"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M4 19h16v2H4zM4 3h8a4 4 0 0 1 4 4v10H4z"/><path d="M16 7h4v10h-4z"/></svg><button>科目</button></div>
  <div class="item" data-nav="review"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3zM3 10h18v2H3zM3 16h12v2H3z"/></svg><button>復習</button></div>
  <div class="item" data-nav="add"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg><button>追加</button></div>
  <div class="item" data-nav="settings"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94a7.07 7.07 0 0 0 .05-.94 7.07 7.07 0 0 0-.05-.94l2.03-1.58-1.92-3.32-2.4.97a7.34 7.34 0 0 0-1.62-.94l-.36-2.54h-3.84l-.36 2.54c-.57.22-1.12.53-1.62.94l-2.4-.97-1.92 3.32L4.86 11.06c-.03.31-.05.62-.05.94 0 .32.02.63.05.94l-2.03 1.58 1.92 3.32 2.4-.97c.5.41 1.05.72 1.62.94l.36 2.54h3.84l.36-2.54c.57-.22 1.12-.53 1.62-.94l2.4.97 1.92-3.32-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7z"/></svg><button>設定</button></div>
  <div class="item" data-nav="exit"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M10 17l5-5-5-5v10z"/><path d="M4 4h6v2H6v12h4v2H4z"/></svg><button>終了</button></div>
</nav>
<button id="mode-fab" aria-label="入力モード切替（全/穴）" title="入力モード切替">全</button>

<main id="app"></main>
<div id="sys-banner" class="banner hidden"></div>
<div id="modal-root"></div>
<div id="errlayer"><div id="errbox"><h3>エラーが発生しました</h3><pre id="errtext"></pre><div class="section"><button onclick="document.getElementById('errlayer').style.display='none'">閉じる</button></div></div></div>
<div id="toast-container"></div>

<button id="iphone-exit" aria-label="終了（iPhone専用）" title="終了">終</button>

<script>
const app = (()=>{
  // ===== Debug overlay =====
  function showError(msg){
    try{
      const txt = (msg && msg.stack) ? msg.stack : (typeof msg==='string' ? msg : JSON.stringify(msg));
      document.getElementById('errtext').textContent = txt;
      document.getElementById('errlayer').style.display = 'flex';
      console.error('[FATAL]', msg);
    }catch(e){ console.error('Error while showing error', e, msg); }
  }
  window.addEventListener('error', e => showError(e.error || e.message));
  window.addEventListener('unhandledrejection', e => showError(e.reason || e));

  const UA = navigator.userAgent || "";
  const IS_IPHONE = /iPhone|iPod/.test(UA) && "ontouchend" in document;
  if (IS_IPHONE) document.documentElement.classList.add('iphone');

  const CORE_SUBJECTS = ["憲法","行政法","民法","刑法","商法","民訴法","刑訴法"];
  const ELECTIVE_SUBJECTS = ["労働法","倒産法","知的財産法","租税法","国際私法","国際公法","経済法","環境法"];
  const ELECTIVE_GROUP = "__ELECTIVE__";
  const IMPORTANCES = ["★重要","★中程度","★低め"];
  const KEY_SPLIT = /[,\u3001\uFF0C\u3002\uFF0E]+/;

  const subjectLabel = (s)=> s===ELECTIVE_GROUP ? "選択科目" : s;
  function importanceLabel(v){
    if (v === "★重要") return "⚫︎ 重要";
    if (v === "★中程度") return "◆ 普通";
    if (v === "★低め") return "▲ 低い";
    return v;
  }

  const VKEYS = ["lawStudyProblemsCache_v91ad8","lawStudyProblemsCache_v91ad7","lawStudyProblemsCache_v91ad6"];
  const CACHE_KEY = VKEYS[0];
  const UI_KEYS = ["lawStudyUI_v91ad8","lawStudyUI_v91ad7","lawStudyUI_v91ad6"];
  const UI_KEY = UI_KEYS[0];

  const CFG_STABLE_KEY = "lawStudyCfg";
  const CFG_OLD_KEYS = ["lawStudyCfg_v91x","lawStudyCfg_v91w"];
  const config = loadConfig();
  function loadConfig(){
    let c = null;
    try{ c = JSON.parse(localStorage.getItem(CFG_STABLE_KEY)); }catch{}
    if (!c){
      for (const k of CFG_OLD_KEYS){
        try{ const v = JSON.parse(localStorage.getItem(k)); if (v){ c=v; break; } }catch{}
      }
    }
    if (!c) c = {
      autoLocalSave:true, autoRestore:true, fileAutoSave:true,
      iosShowImportAtBoot:true, iosShowExportGuide:true,
      mixRatio: {unsure:5, fail:3, other:2},
      enableCommandPalette: true
    };
    ["autoLocalSave","autoRestore","fileAutoSave","iosShowImportAtBoot","iosShowExportGuide","mixRatio","enableCommandPalette"].forEach(k=>{
      if (typeof c[k]==="undefined") c[k]= (k==="mixRatio"?{unsure:5,fail:3,other:2} : true);
    });
    return c;
  }
  function saveConfig(){ localStorage.setItem(CFG_STABLE_KEY, JSON.stringify(config)); }

  // ====== 日付（ローカル基準） ======
  const ymdLocal = (d=new Date())=>{
    const t=new Date(d); t.setHours(0,0,0,0);
    const y=t.getFullYear(), m=t.getMonth()+1, dd=t.getDate();
    return `${y}-${String(m).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
  };
  const addDaysLocal = (days)=>{
    const t=new Date(); t.setHours(0,0,0,0); t.setDate(t.getDate()+days);
    return ymdLocal(t);
  };
  const parseYMD = (s)=>{ const [y,m,d]=s.split('-').map(Number); const dt=new Date(y,m-1,d); dt.setHours(0,0,0,0); return dt; };
  const daysBetweenLocal = (ymdA, ymdB)=> Math.round((parseYMD(ymdA)-parseYMD(ymdB))/(1000*60*60*24));

  // ====== 日次カウント ======
  const DAILY_KEY = "lawStudyDaily_v1";
  function getDailyMap(){
    try{ return JSON.parse(localStorage.getItem(DAILY_KEY)) || {}; }catch{ return {}; }
  }
  function setDailyMap(m){ localStorage.setItem(DAILY_KEY, JSON.stringify(m)); }
  function addDailyAnswered(n=1){
    const t = ymdLocal(new Date());
    const m = getDailyMap(); m[t] = (m[t]||0) + n; setDailyMap(m);
  }
  function calcStreak(){
    const m = getDailyMap();
    let streak = 0;
    for (let back=0; ; back++){
      const d = new Date(); d.setDate(d.getDate()-back);
      const ymd = ymdLocal(d);
      if ((m[ymd]||0) > 0) streak++;
      else break;
    }
    return streak;
  }
  function todayCount(){ const m=getDailyMap(); const t=ymdLocal(new Date()); return m[t]||0; }

  // ====== ローカル保存 ======
  function saveLocal(problems, sessions){
    if (!config.autoLocalSave) return;
    const payload = { updatedAt: new Date().toISOString(), problems, sessions: sessionsState.logs };
    localStorage.setItem(CACHE_KEY, JSON.stringify(payload));
    updateNavBadges();
  }
  function loadLocal(){
    for (const key of VKEYS){
      try{
        const s = localStorage.getItem(key);
        if (!s) continue;
        const obj = JSON.parse(s);
        if (obj && Array.isArray(obj.problems)) return obj;
      }catch{}
    }
    return null;
  }
  function clearLocal(){ localStorage.removeItem(CACHE_KEY); updateNavBadges(); }

  function saveUI(ui){ localStorage.setItem(UI_KEY, JSON.stringify(ui)); }
  function loadUI(){
    for (const k of UI_KEYS){
      try{
        const s = localStorage.getItem(k);
        if (s) return JSON.parse(s);
      }catch{}
    }
    return {};
  }

  // ====== IDB（ファイルハンドル保存） ======
  const DB_NAME = 'lawStudyFS';
  const STORE = 'handles';
  function idbOpen(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = () => { req.result.createObjectStore(STORE); };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbSet(key, val){
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, 'readwrite');
      tx.objectStore(STORE).put(val, key);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }
  async function idbGet(key){
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, 'readonly');
      const req = tx.objectStore(STORE).get(key);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbDelete(key){
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, 'readwrite');
      tx.objectStore(STORE).delete(key);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  let fileHandle = null;
  let fileSaveTimer = null;
  const supportsFS = !!(window.showOpenFilePicker || window.showSaveFilePicker);

  function banner(html){ const el=document.getElementById('sys-banner'); el.innerHTML=html; el.classList.remove('hidden'); }
  function hideBanner(){ document.getElementById('sys-banner').classList.add('hidden'); }

  async function pickFile(){
    if (!supportsFS) { showToast("このブラウザはファイル連携をサポートしていません。"); return; }
    try{
      const [handle] = await window.showOpenFilePicker({
        types: [{description:"JSON", accept: {"application/json": [".json"]}}],
        excludeAcceptAllOption: true, multiple: false
      });
      let perm = await handle.queryPermission({mode:"readwrite"});
      if (perm !== "granted") perm = await handle.requestPermission({mode:"readwrite"});
      if (perm !== "granted") { showToast("書き込み権限がありません。", "error"); return; }
      fileHandle = handle;
      await idbSet('problems', handle);
      await saveToFile();
      showToast('iCloud Drive のファイルに接続しました。');
      render();
    }catch(e){ console.warn(e); }
  }

  async function tryRestoreFileHandle(autoPrompt=true){
    if (!supportsFS) return false;
    try{
      const handle = await idbGet('problems');
      if (!handle) return false;
      let perm = await handle.queryPermission({mode:"readwrite"});
      if (perm === "prompt" && autoPrompt){
        perm = await handle.requestPermission({mode:"readwrite"});
      }
      if (perm === "granted"){
        fileHandle = handle;
        const ok = await loadFromFile();
        if (ok){
          showToast('同期ファイルを読み込みました。');
          return true;
        }
      }
    }catch(e){ console.warn("restore handle failed:", e); }
    return false;
  }

  async function loadFromFile(){
    if (!fileHandle) return false;
    try{
      const file = await fileHandle.getFile();
      const text = await file.text();
      const data = text ? JSON.parse(text) : [];
      if (!Array.isArray(data)) throw new Error("JSONは配列ではありません（v9互換）");
      sanitizeProblems(data);
      state.problems = data;
      reindex();
      saveLocal(state.problems, sessionsState.logs);
      render();
      return true;
    }catch(e){
      console.warn("ファイル読込失敗:", e);
      showToast('problems.json の読み込みに失敗しました: '+ e.message, 'error');
      return false;
    }
  }

  async function saveToFile(){
    if (!fileHandle) return;
    try{
      const writable = await fileHandle.createWritable();
      await writable.write(JSON.stringify(state.problems, null, 2));
      await writable.close();
    }catch(e){ console.warn("ファイル保存に失敗:", e); }
  }
  function scheduleFileSave(){
    if (!fileHandle) return;
    if (fileSaveTimer) clearTimeout(fileSaveTimer);
    fileSaveTimer = setTimeout(saveToFile, 200);
  }

  function sanitizeProblems(arr){
    if (!Array.isArray(arr)) throw new Error("不正なデータ形式");
    arr.forEach(p => {
      if (!Array.isArray(p.history)) p.history = [];
      if (!Array.isArray(p.reviews)) p.reviews = [];
      if (!p.example) p.example = "";
      if (!p.note) p.note = "";
      if (!p.subject) p.subject = "未分類";
      if (!p.importance) p.importance = "★中程度";
      if (!p.selfStats) p.selfStats = {perfect:0,unsure:0,fail:0};
      if (typeof p.weakPoints !== 'number') p.weakPoints = 0;
      if (typeof p.topic === "undefined") p.topic = "";
      if (typeof p.subtopic === "undefined") p.subtopic = "";
    });
  }

  // ====== 監査ログ ======
  const sessionsState = {
    current: null,
    logs: []
  };
  function startSession(ids, random, mode){
    endSession();
    sessionsState.current = {
      id: Date.now()+Math.floor(Math.random()*1000),
      startAt: new Date().toISOString(),
      endAt: null,
      context: {subject: state.currentSubject, topic: state.currentTopic, subtopic: state.currentSubtopic, random: !!random, mode: mode||null},
      planned: ids.length,
      answered: 0,
      scoreCount: {ok:0, good:0, low:0, bad:0}
    };
    saveLocal(state.problems, sessionsState.logs);
  }
  function bumpSessionOnScore(scoreChar){
    if (!sessionsState.current) return;
    sessionsState.current.answered++;
    if (scoreChar==="◎") sessionsState.current.scoreCount.ok++;
    else if (scoreChar==="○") sessionsState.current.scoreCount.good++;
    else if (scoreChar==="△") sessionsState.current.scoreCount.low++;
    else sessionsState.current.scoreCount.bad++;
    saveLocal(state.problems, sessionsState.logs);
  }
  function endSession(){
    if (!sessionsState.current) return;
    const s = sessionsState.current;
    s.endAt = new Date().toISOString();
    try{
      s.durationSec = Math.max(0, Math.round((new Date(s.endAt)-new Date(s.startAt))/1000));
    }catch{ s.durationSec = null; }
    sessionsState.logs.push(s);
    sessionsState.current = null;
    saveLocal(state.problems, sessionsState.logs);
  }
  function exportSessionCSV(){
    const rows = [["id","startAt","endAt","durationSec","subject","topic","subtopic","random","planned","answered","ok","good","low","bad"]];
    sessionsState.logs.forEach(l=>{
      rows.push([l.id,l.startAt,l.endAt,l.durationSec,
        l.context?.subject||"", l.context?.topic||"", l.context?.subtopic||"", l.context?.random?1:0,
        l.planned, l.answered, l.scoreCount.ok, l.scoreCount.good, l.scoreCount.low, l.scoreCount.bad]);
    });
    const csv = rows.map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "study-sessions.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  const state = {
    view: 'home',
    problems: [],
    currentSubject: null,
    currentTopic: 'all',
    currentSubtopic: 'all',
    currentImportance: 'all',
    currentSelf: 'all',
    currentProblemId: null,
    reviewQueue: null,
    reviewTab: 'today', // 'today', 'weak', 'custom'
    reviewTodayListVisible: false,
    timerStart: null,
    timerTick: null
  };

  // ====== インデックス ======
  let indexCache = null;
  function reindex(){
    const subjects = new Map();
    const topics = new Map();
    const subtopics = new Map();
    state.problems.forEach(p=>{
      const subj = (p.subject===ELECTIVE_GROUP || ELECTIVE_SUBJECTS.includes(p.subject)) ? (p.subject===ELECTIVE_GROUP?ELECTIVE_GROUP:p.subject) : p.subject;
      if (!subjects.has(subj)) subjects.set(subj, []);
      subjects.get(subj).push(p.id);
      const t = (p.topic||"");
      const st = (p.subtopic||"");
      if (!topics.has(subj)) topics.set(subj, new Map());
      if (!topics.get(subj).has(t)) topics.get(subj).set(t, []);
      topics.get(subj).get(t).push(p.id);
      if (!subtopics.has(subj)) subtopics.set(subj, new Map());
      if (!subtopics.get(subj).has(t)) subtopics.get(subj).set(t, new Map());
      if (!subtopics.get(subj).get(t).has(st)) subtopics.get(subj).get(t).set(st, []);
      subtopics.get(subj).get(t).get(st).push(p.id);
    });
    indexCache = {subjects, topics, subtopics};
  }
  function idsBySubject(s){ if (!indexCache) reindex(); if (s===ELECTIVE_GROUP){ const ids=new Set(indexCache.subjects.get(ELECTIVE_GROUP)||[]); ELECTIVE_SUBJECTS.forEach(x=> (indexCache.subjects.get(x)||[]).forEach(id=>ids.add(id))); return [...ids]; } return (indexCache.subjects.get(s)||[]).slice(); }
  function idsByTopic(s,t){ if (!indexCache) reindex(); return ((indexCache.topics.get(s)||new Map()).get(t||"")||[]).slice(); }
  function idsBySubtopic(s,t,st){ if (!indexCache) reindex(); return (((indexCache.subtopics.get(s)||new Map()).get(t||"")||new Map()).get(st||"")||[]).slice(); }
  
  function topicsForSubject(subj){
    const list = idsBySubject(subj)
      .map(id => idToProb(id))
      .filter(Boolean)
      .map(p => (p.topic||"").trim())
      .filter(t=>t);
    return Array.from(new Set(list)).sort((a,b)=> a.localeCompare(b,'ja'));
  }
  function subtopicsFor(subj, topic){
    const list = idsByTopic(subj, topic)
      .map(id => idToProb(id))
      .filter(Boolean)
      .map(p => (p.subtopic||"").trim())
      .filter(t=>t);
    return Array.from(new Set(list)).sort((a,b)=> a.localeCompare(b,'ja'));
  }

  const $app = document.getElementById('app');

  function setActive(view){
    state.view = view;
    if (view !== 'quiz') { state.reviewQueue = null; endSession(); stopTimer(); }
    if (view === 'review') { state.reviewTab = 'today'; }
    render();
    
    document.querySelectorAll('#rail .nav button, #tabbar .item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll(`[data-nav="${view}"]`).forEach(el => el.classList.add('active'));

    saveUI({
      currentSubject: state.currentSubject,
      currentTopic: state.currentTopic,
      currentSubtopic: state.currentSubtopic,
      currentImportance: state.currentImportance,
      currentProblemId: state.currentProblemId,
      currentSelf: state.currentSelf
    });
    updateNavBadges();
  }

  function latestSelfTag(p){
    if (!p || !Array.isArray(p.history) || p.history.length===0) return null;
    for (let i=p.history.length-1;i>=0;i--){
      if (p.history[i] && p.history[i].self) return p.history[i].self;
    }
    return null;
  }
  function todayStr(){ return ymdLocal(new Date()); }
  function escapeHtml(s){ return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
  function idToProb(id){ return state.problems.find(p=>p.id===id); }
  function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

  function filtered(){
    let arr = problemsBySubjectFiltered(state.currentSubject);
    if (state.currentTopic !== 'all'){ arr = arr.filter(p => (p.topic||"") === state.currentTopic); }
    if (state.currentSubtopic !== 'all'){ arr = arr.filter(p => (p.subtopic||"") === state.currentSubtopic); }
    return arr;
  }
  function meetsFilters(p){
    const impOk = (state.currentImportance==='all') || (p.importance===state.currentImportance);
    const tag = latestSelfTag(p);
    const selfOk = (state.currentSelf==='all') || (tag===state.currentSelf);
    return impOk && selfOk;
  }
  function problemsBySubjectFiltered(subj){
    const ids = idsBySubject(subj);
    return ids.map(id=>idToProb(id)).filter(Boolean).filter(meetsFilters);
  }

  // ====== 復習バッジ ======
  function getDueTodayIds(){
    const t = todayStr();
    const dueToday = new Set();
    state.problems.forEach(p => {
      const revs = (p.reviews||[]).filter(d => d <= t);
      if (revs.length) dueToday.add(p.id);
    });
    if (dueToday.size===0){
      const intervals = [1,3,7,14,30];
      state.problems.forEach(p => {
        const last = lastAnswerYmdLocal(p);
        if (!last) return;
        const d = daysBetweenLocal(t, last);
        if (intervals.includes(d) || d > intervals[intervals.length-1]) dueToday.add(p.id);
      });
    }
    return Array.from(dueToday);
  }
  function getDueTodayCount(){ return getDueTodayIds().length; }
  function updateNavBadges(){
    const btn = document.querySelector('[data-nav="review"]');
    if (!btn) return;
    const n = getDueTodayCount();
    const labelEl = btn.querySelector('button') || btn;
    const existingBadge = btn.querySelector('.badge');
    if(existingBadge) existingBadge.remove();

    if (n > 0){
      const shown = (n > 99 ? "99+" : String(n));
      labelEl.innerHTML += ` <span class="badge" title="${n}件">${shown}</span>`;
    }
  }

  // ====== 弱点ドリル ======
  function buildWeakDrillWeighted(allIds, ratio, takeN, doShuffle){
    const buckets = {unsure:[], fail:[], other:[]};
    allIds.forEach(id=>{
      const p = idToProb(id);
      const last = latestSelfTag(p);
      const weight = Math.max(0, Number(p.weakPoints||0));
      const rec = {id, weight};
      if (last==='unsure') buckets.unsure.push(rec);
      else if (last==='fail') buckets.fail.push(rec);
      else buckets.other.push(rec);
    });
    buckets.unsure.sort((a,b)=> b.weight - a.weight);
    buckets.fail.sort((a,b)=> b.weight - a.weight);
    buckets.other.sort((a,b)=> b.weight - a.weight);

    const N = Math.max(1, Number(takeN||20));
    const result = [];
    let iu=0, ifa=0, io=0;
    while (result.length < N && (iu<buckets.unsure.length || ifa<buckets.fail.length || io<buckets.other.length)){
      for(let i=0; i<ratio.unsure && result.length<N && iu<buckets.unsure.length; i++){ result.push(buckets.unsure[iu++].id); }
      for(let i=0; i<ratio.fail   && result.length<N && ifa<buckets.fail.length;   i++){ result.push(buckets.fail[ifa++].id); }
      for(let i=0; i<ratio.other  && result.length<N && io<buckets.other.length;  i++){ result.push(buckets.other[io++].id); }
      if (iu>=buckets.unsure.length && ifa>=buckets.fail.length && io<buckets.other.length){
        while (io<buckets.other.length && result.length<N){ result.push(buckets.other[io++].id); }
      }
    }
    if (doShuffle){
      for(let i=result.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [result[i],result[j]]=[result[j],result[i]]; }
    }
    return result;
  }
  
  function render(){
    try{
      if (state.view === 'home')     return renderHome();
      if (state.view === 'search')   return renderSearch();
      if (state.view === 'subjects') return renderSubjects();
      if (state.view === 'topics')   return renderTopics();
      if (state.view === 'subtopics')return renderSubtopics();
      if (state.view === 'list')     return renderList();
      if (state.view === 'quiz')     return renderQuiz();
      if (state.view === 'add')      return renderAdd();
      if (state.view === 'review')   return renderReview();
      if (state.view === 'edit')     return renderEdit();
      if (state.view === 'settings') return renderSettings();
    } catch(e){ showError(e); }
  }

  function calculateAllSubjectStats() {
    const allSubjects = [...CORE_SUBJECTS, ELECTIVE_GROUP];
    return allSubjects.map(subjectName => {
      const problemIds = idsBySubject(subjectName);
      const problems = problemIds.map(id => idToProb(id)).filter(Boolean);
      
      const totalProblems = problems.length;
      if (totalProblems === 0) {
        return { subjectName, achievementRate: 0, correctRate: 0, totalProblems: 0 };
      }

      const answeredProblems = problems.filter(p => p.history && p.history.length > 0);
      const achievementRate = (answeredProblems.length / totalProblems) * 100;

      let correctAnswers = 0;
      let totalAnswers = 0;
      problems.forEach(p => {
        if (p.history && p.history.length > 0) {
          p.history.forEach(h => {
            if (h.score === '◎' || h.score === '○') {
              correctAnswers++;
            }
          });
          totalAnswers += p.history.length;
        }
      });
      
      const correctRate = totalAnswers > 0 ? (correctAnswers / totalAnswers) * 100 : 0;

      return { subjectName: subjectLabel(subjectName), achievementRate, correctRate, totalProblems };
    }).filter(s => s.totalProblems > 0);
  }
  
  function calculateRadarChartData() {
    const subjects = [...CORE_SUBJECTS, ELECTIVE_GROUP];
    const labels = subjects.map(s => subjectLabel(s));
    const totalAnswersData = [];
    const correctRateData = [];

    subjects.forEach(subjectName => {
        const problemIds = idsBySubject(subjectName);
        const problems = problemIds.map(id => idToProb(id)).filter(Boolean);

        let totalAnswers = 0;
        let correctAnswers = 0;

        problems.forEach(p => {
            if (p.history && p.history.length > 0) {
                totalAnswers += p.history.length;
                p.history.forEach(h => {
                    if (h.score === '◎' || h.score === '○') {
                        correctAnswers++;
                    }
                });
            }
        });

        totalAnswersData.push(totalAnswers);
        const rate = totalAnswers > 0 ? (correctAnswers / totalAnswers) * 100 : 0;
        correctRateData.push(rate);
    });

    const maxAnswers = Math.max(...totalAnswersData);
    const normalizedAnswersData = maxAnswers > 0 ? totalAnswersData.map(d => (d / maxAnswers) * 100) : totalAnswersData.map(() => 0);

    return {
        labels,
        datasets: [
            {
                label: '総回答数',
                data: normalizedAnswersData,
                originalData: totalAnswersData,
                backgroundColor: 'rgba(14, 34, 64, 0.2)',
                borderColor: 'rgba(14, 34, 64, 1)',
                pointBackgroundColor: 'rgba(14, 34, 64, 1)',
            },
            {
                label: '正答率',
                data: correctRateData,
                originalData: correctRateData,
                backgroundColor: 'rgba(180, 136, 59, 0.2)',
                borderColor: 'rgba(180, 136, 59, 1)',
                pointBackgroundColor: 'rgba(180, 136, 59, 1)',
            }
        ]
    };
  }

  function getAnsweredDueTodayCount() {
    const today = todayStr();
    const dueIds = getDueTodayIds();
    let answeredCount = 0;
    dueIds.forEach(id => {
        const p = idToProb(id);
        if (p && p.history) {
            const answeredToday = p.history.some(h => ymdLocal(new Date(h.date)) === today);
            if (answeredToday) {
                answeredCount++;
            }
        }
    });
    return answeredCount;
  }

  function calculateGlobalStats() {
    const totalProblems = state.problems.length;
    const answeredProblems = state.problems.filter(p => p.history && p.history.length > 0).length;
    
    let totalAnswers = 0;
    let correctAnswers = 0;
    state.problems.forEach(p => {
      if (p.history && p.history.length > 0) {
        totalAnswers += p.history.length;
        p.history.forEach(h => {
          if (h.score === '◎' || h.score === '○') {
            correctAnswers++;
          }
        });
      }
    });

    const correctRate = totalAnswers > 0 ? (correctAnswers / totalAnswers) * 100 : 0;

    return { totalProblems, answeredProblems, totalAnswers, correctRate };
  }

  let radarChart = null;
  function renderHome() {
    const dueCount = getDueTodayCount();
    const answeredDueToday = getAnsweredDueTodayCount();
    const answeredToday = todayCount();
    const streak = calcStreak();
    const radarData = calculateRadarChartData();
    const globalStats = calculateGlobalStats();
    
    $app.innerHTML = `
      <div class="card">
        <h2>ホーム</h2>
        <h3>今日の進捗</h3>
        <div class="home-grid section">
          <div class="stat-card">
            <div class="value">${answeredDueToday}<span class="unit">/ ${dueCount} 件</span></div>
            <div class="label">今日の復習</div>
          </div>
          <div class="stat-card">
            <div class="value">${answeredToday}<span class="unit">件</span></div>
            <div class="label">本日の解答数</div>
          </div>
          <div class="stat-card">
            <div class="value">${streak}<span class="unit">日</span></div>
            <div class="label">継続日数</div>
          </div>
        </div>
        <h3 class="section">全体の進捗</h3>
        <div class="home-grid section">
           <div class="stat-card">
            <div class="value">${globalStats.answeredProblems}<span class="unit">/ ${globalStats.totalProblems} 問</span></div>
            <div class="label">解答済み問題</div>
          </div>
          <div class="stat-card">
            <div class="value">${globalStats.totalAnswers}<span class="unit">回</span></div>
            <div class="label">総解答数</div>
          </div>
          <div class="stat-card">
            <div class="value">${globalStats.correctRate.toFixed(1)}<span class="unit">%</span></div>
            <div class="label">総正解率</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>学習バランス</h3>
        <canvas id="radarChart"></canvas>
      </div>
    `;

    // Render Chart
    const ctx = document.getElementById('radarChart');
    if (radarChart) {
        radarChart.destroy();
    }
    radarChart = new Chart(ctx, {
        type: 'radar',
        data: radarData,
        options: {
            scales: {
                r: {
                    angleLines: { display: true },
                    suggestedMin: 0,
                    suggestedMax: 100,
                    pointLabels: { font: { size: 12, weight: 'bold' } },
                    ticks: { backdropColor: 'transparent' }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) { label += ': '; }
                            if (context.dataset.label.includes('総回答数')) {
                                label += context.dataset.originalData[context.dataIndex] + '回';
                            } else {
                                label += parseFloat(context.raw).toFixed(1) + '%';
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
  }

  function renderSearch() {
    $app.innerHTML = `
      <div class="card">
        <h2>問題の検索</h2>
        <div class="section">
          <input type="search" id="search-input" placeholder="問題文、分野、小分類で検索...">
        </div>
        <div id="search-results" class="section">
          <p class="muted">検索キーワードを入力してください。</p>
        </div>
      </div>
    `;

    const input = document.getElementById('search-input');
    const resultsContainer = document.getElementById('search-results');

    input.addEventListener('input', () => {
      const query = input.value.toLowerCase().trim();
      if (query.length < 1) {
        resultsContainer.innerHTML = '<p class="muted">検索キーワードを入力してください。</p>';
        return;
      }

      const results = state.problems.filter(p => 
        (p.question || '').toLowerCase().includes(query) ||
        (p.topic || '').toLowerCase().includes(query) ||
        (p.subtopic || '').toLowerCase().includes(query)
      );

      if (results.length === 0) {
        resultsContainer.innerHTML = '<p class="muted">該当する問題はありませんでした。</p>';
        return;
      }

      resultsContainer.innerHTML = results.map(p => `
        <div class="list-item">
          <div class="flex">
            <div class="space">
              <strong>${escapeHtml(p.question)}</strong>
              <div class="muted small">${escapeHtml(subjectLabel(p.subject))} > ${escapeHtml(p.topic)} > ${escapeHtml(p.subtopic)}</div>
            </div>
            <button class="ghost" onclick="app.startQuiz(${p.id})">解く</button>
            <button class="ghost" onclick="app.editProblem(${p.id})">編集</button>
          </div>
        </div>
      `).join('');
    });
  }

  function filterBarHTML(){
    const impOpts = `
      <option value="all" ${state.currentImportance==='all'?'selected':''}>すべて</option>
      ${IMPORTANCES.map(im=>`<option value="${im}" ${state.currentImportance===im?'selected':''}>${importanceLabel(im)}</option>`).join('')}
    `;
    const selfOpts = `
      <option value="all" ${state.currentSelf==='all'?'selected':''}>すべて</option>
      <option value="perfect" ${state.currentSelf==='perfect'?'selected':''}>できた</option>
      <option value="unsure" ${state.currentSelf==='unsure'?'selected':''}>普通</option>
      <option value="fail" ${state.currentSelf==='fail'?'selected':''}>できない</option>
    `;
    return `
      <div class="section flex" style="gap:.75rem;align-items:center">
        <label class="small">重要度：</label>
        <select onchange="app.setImp(this.value)">${impOpts}</select>
        <label class="small">自己評価：</label>
        <select onchange="app.setSelf(this.value)">${selfOpts}</select>
        <label class="small" style="margin-left:1rem">件数</label>
        <input type="number" id="count-subject" min="1" step="1" placeholder="（空=全件）" style="max-width:6rem">
        <div class="space"></div>
        <button class="ghost" onclick="app.resetFilters()">リセット</button>
      </div>
    `;
  }
  
  function rawCountBySubject(name){
    const ids = idsBySubject(name);
    return ids.map(id=>idToProb(id)).filter(Boolean).filter(meetsFilters).length;
  }

  function renderSubjects(){
    const coreHtml = CORE_SUBJECTS.map(s=>`
      <div class="list-item" style="cursor:pointer" onclick="app.selectSubject('${s}')">
        <div class="flex">
          <strong>${s}</strong>
          <span class="pill">${rawCountBySubject(s)} 問</span>
          <div class="space"></div>
        </div>
      </div>`).join('');

    const electiveHtml = `
      <div class="list-item" style="cursor:pointer" onclick="app.selectElective()">
        <div class="flex">
          <strong>選択科目</strong>
          <span class="pill">${rawCountBySubject("__ELECTIVE__")} 問</span>
          <div class="space"></div>
        </div>
      </div>
    `;

    $app.innerHTML = `
      <div class="card">
        <h2>科目を選んでください</h2>
        <div class="section">
          <h3>必修科目</h3>
          <div class="home-grid section">
            ${coreHtml || '<div class="muted">（未登録でも選択できます）</div>'}
          </div>
        </div>
        <div class="section">
          <h3>選択科目</h3>
          <div class="home-grid section">
            ${electiveHtml}
          </div>
        </div>
      </div>
    `;
  }
  
  function topicCount(subj, topic){ return idsByTopic(subj, topic).map(id=>idToProb(id)).filter(Boolean).filter(meetsFilters).length; }
  function unclassifiedTopicCount(subj){ return idsByTopic(subj, "").map(id=>idToProb(id)).filter(Boolean).filter(meetsFilters).length; }

  function getSubjectCount(){
    const inp = document.getElementById('count-subject');
    if (!inp) return null;
    const v = Math.floor(Number(inp.value||0));
    return (isFinite(v) && v>0) ? v : null;
  }
  function pickWithLimit(ids, n, rnd){
    let arr = ids.slice();
    if (n && rnd){
      for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      arr = arr.slice(0, n);
      return arr;
    }
    if (n){ return arr.slice(0, n); }
    return arr;
  }

  function renderTopics(){
    const subj = state.currentSubject;
    if (!subj){ setActive('subjects'); return; }
    const topics = topicsForSubject(subj);
    const list = topics.filter(t=>t).map(t=>`
      <div class="list-item" style="cursor:pointer" onclick="app.selectTopic('${t.replace(/'/g,"\\'")}')">
        <div class="list-title">
          <strong>${t}</strong>
          <span class="pill">${topicCount(subj, t)} 件</span>
        </div>
        <div class="list-actions">
          <button class="ghost" onclick="event.stopPropagation();app.startTopic('${t.replace(/'/g,"\\'")}', false)">順番</button>
          <button class="ghost" onclick="event.stopPropagation();app.startTopic('${t.replace(/'/g,"\\'")}', true)">ランダム</button>
        </div>
      </div>
    `).join('');

    const subjectCount = rawCountBySubject(subj);

    $app.innerHTML = `
      <div class="card">
        <div class="flex">
          <button class="ghost" onclick="app.setActive('subjects')">← 科目一覧</button>
          <h2 style="margin:0 .5rem">科目：${subjectLabel(subj)}（${subjectCount} 件）</h2>
        </div>
        ${filterBarHTML()}
        <div class="section">
          <div class="list-item">
            <div style="cursor:pointer" onclick="app.selectTopic('all')" class="list-title">
              <strong>（この科目の全て）</strong>
              <span class="pill">${subjectCount} 件</span>
            </div>
            <div class="list-actions">
              <button class="ghost" onclick="app.startSubjectAll(false)">順番</button>
              <button class="ghost" onclick="app.startSubjectAll(true)">ランダム</button>
            </div>
          </div>
        </div>
        <div class="section">
          <h3>分野</h3>
          <div class="home-grid">
            ${list || '<div class="muted">（この条件に一致する分野はありません）</div>'}
          </div>
        </div>
        ${unclassifiedTopicCount(subj)>0 ? `
        <div class="section">
          <h3>未分類の分野</h3>
          <div class="list-item">
            <div style="cursor:pointer" onclick="app.selectTopic('')" class="list-title">
              <strong>未分類</strong>
              <span class="pill">${unclassifiedTopicCount(subj)} 件</span>
            </div>
            <div class="list-actions">
              <button class="ghost" onclick="app.startTopic('', false)">順番</button>
              <button class="ghost" onclick="event.stopPropagation();app.startTopic('', true)">ランダム</button>
            </div>
          </div>
        </div>` : ''}
      </div>
    `;
  }
  
  function subtopicCount(subj, topic, subtopic){ return idsBySubtopic(subj, topic, subtopic).map(id=>idToProb(id)).filter(Boolean).filter(meetsFilters).length; }
  function unclassifiedSubtopicCount(subj, topic){ return idsBySubtopic(subj, topic, "").map(id=>idToProb(id)).filter(Boolean).filter(meetsFilters).length; }
  
  function renderSubtopics(){
    const subj = state.currentSubject;
    const topic = state.currentTopic;
    if (!subj) { setActive('subjects'); return; }
    if (topic==='all'){ setActive('list'); return; }

    const subs = subtopicsFor(subj, topic);
    const list = subs.map(st=>`
      <div class="list-item" style="cursor:pointer" onclick="app.selectSubtopic('${st.replace(/'/g,"\\'")}')">
        <div class="list-title">
          <strong>${st}</strong>
          <span class="pill">${subtopicCount(subj, topic, st)} 件</span>
        </div>
        <div class="list-actions">
          <button class="ghost" onclick="event.stopPropagation();app.startSubtopic('${st.replace(/'/g,"\\'")}', false)">順番</button>
          <button class="ghost" onclick="event.stopPropagation();app.startSubtopic('${st.replace(/'/g,"\\'")}', true)">ランダム</button>
        </div>
      </div>
    `).join('');

    const topicAll = idsByTopic(subj, topic).map(id=>idToProb(id)).filter(Boolean).filter(meetsFilters).length;

    $app.innerHTML = `
      <div class="card">
        <div class="flex">
          <button class="ghost" onclick="app.setActive('topics')">← 分野一覧</button>
          <button class="ghost" onclick="app.setActive('subjects')">← 科目一覧</button>
          <h2 style="margin:0 .5rem">科目：${subjectLabel(subj)} / 分野：${topic}（${topicAll} 件）</h2>
        </div>
        <div class="section">
          <div class="list-item">
            <div style="cursor:pointer" onclick="app.selectSubtopic('all')" class="list-title">
              <strong>（この分野の全て）</strong>
              <span class="pill">${topicAll} 件</span>
            </div>
            <div class="list-actions">
              <button class="ghost" onclick="app.startTopicAll(false)">順番</button>
              <button class="ghost" onclick="app.startTopicAll(true)">ランダム</button>
            </div>
          </div>
        </div>
        <div class="section">
          <h3>小分類</h3>
          <div class="home-grid">
            ${list || '<div class="muted">（この条件に一致する小分類はありません）</div>'}
          </div>
        </div>
        ${unclassifiedSubtopicCount(subj, topic)>0 ? `
        <div class="section">
          <h3>未分類の小分類</h3>
          <div class="list-item">
            <div style="cursor:pointer" onclick="app.selectSubtopic('')" class="list-title">
              <strong>未分類</strong>
              <span class="pill">${unclassifiedSubtopicCount(subj, topic)} 件</span>
            </div>
            <div class="list-actions">
              <button class="ghost" onclick="app.startSubtopic('', false)">順番</button>
              <button class="ghost" onclick="event.stopPropagation();app.startSubtopic('', true)">ランダム</button>
            </div>
          </div>
        </div>` : ''}
      </div>
    `;
  }

  function startQueue(ids, randomize, mode){
    const q = (randomize ? shuffle(ids) : ids.slice());
    if (!q.length) return;
    state.reviewQueue = q;
    state.currentProblemId = q[0];
    startSession(q, randomize, mode||null);
    setActive('quiz');
  }

  function renderList(){
    const list = filtered();
    const topicLabel = state.currentTopic==='all' ? '（全て）' : state.currentTopic==='' ? '未分類' : state.currentTopic;
    const subLabel = state.currentSubtopic==='all' ? '（全て）' : state.currentSubtopic==='' ? '未分類' : state.currentSubtopic;

    const ids = list.map(p=>p.id);
    const disabled = ids.length===0? 'disabled':'';

    $app.innerHTML = `
      <div class="card">
        <div class="flex">
          ${state.currentTopic!=='all' ? `<button class="ghost" onclick="app.setActive('subtopics')">← 小分類一覧</button>` : ''}
          <button class="ghost" onclick="app.setActive('topics')">← 分野一覧</button>
          <button class="ghost" onclick="app.setActive('subjects')">← 科目一覧</button>
          <h2 style="margin:0 .5rem">科目：${subjectLabel(state.currentSubject)} / 分野：${topicLabel} / 小分類：${subLabel}（${list.length} 件）</h2>
        </div>
        <div class="section">
          <div class="list-title"><strong>この一覧の全問題を連続演習：</strong></div>
          <div class="list-actions">
            <button class="ghost" ${disabled} onclick="app.startAll(false)">順番</button>
            <button class="ghost" ${disabled} onclick="app.startAll(true)">ランダム</button>
          </div>
        </div>
        <div class="section">
          ${list.length===0 ? '<div class="muted">この条件の問題はありません。</div>' :
            list.map(p=>{
              const tag = latestSelfTag(p);
              const tagLabel = tag==='perfect'?'できた':tag==='unsure'?'普通':tag==='fail'?'できない':'未評価';
              const tagBadge = tag ? `<span class="pill">${tagLabel}</span>` : '<span class="pill">未評価</span>';
              return `
              <div class="list-item">
                <div class="row">
                  <div class="space"><strong>${p.question}</strong></div>
                  <div class="pill">${importanceLabel(p.importance)}</div>
                  ${tagBadge}
                </div>
                <div class="section flex">
                  <button class="primary" onclick="app.startQuiz(${p.id})">この問題を解く</button>
                  <button class="ghost" onclick="app.editProblem(${p.id})">編集</button>
                  <button class="ghost danger" onclick="app.deleteProblem(${p.id})">削除</button>
                </div>
              </div>`;
            }).join('')
          }
        </div>
      </div>
    `;
  }
  
  function idsForNav(){
    if (Array.isArray(state.reviewQueue) && state.reviewQueue.length){
      return state.reviewQueue.slice();
    }
    return filtered().map(p=>p.id);
  }
  function navNextId(){ const ids = idsForNav(); const i = ids.indexOf(state.currentProblemId); return (i>=0 && i<ids.length-1) ? ids[i+1] : null; }
  function navPrevId(){ const ids = idsForNav(); const i = ids.indexOf(state.currentProblemId); return (i>0) ? ids[i-1] : null; }

  function stopTimer(){ if (state.timerTick){ clearInterval(state.timerTick); state.timerTick=null; } state.timerStart=null; }
  function startTimer(){ stopTimer(); state.timerStart=Date.now(); const el=document.getElementById('timer'); if (!el) return; const fmt=(s)=>{ const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return m+':'+ss;}; el.textContent='00:00'; state.timerTick=setInterval(()=>{ const secs=Math.floor((Date.now()-state.timerStart)/1000); el.textContent=fmt(secs); }, 500); }

  function renderQuiz(){
    const p = state.problems.find(x=>x.id===state.currentProblemId);
    if (!p) { setActive('subjects'); return; }
    const prevExists = !!navPrevId();
    const nextExists = !!navNextId();
    $app.innerHTML = `
      <div class="card">
        <div class="flex">
          <button class="back-to-list ghost" onclick="app.setActive('list')">← 問題一覧</button>
          <h2 style="margin:0 .5rem">Q: ${p.question}</h2>
          <div class="space"></div>
          <div class="small">タイマー：<span id="timer" class="timer">00:00</span></div><div class="small muted" style="margin-left:.75rem">入力モード：${getInputMode()==="cloze"?"穴埋め":"全文"}</div>
        </div>
        <div class="section">
          <label>あなたの回答</label>
          <textarea id="answer" ${ (getInputMode()==='cloze' && (p.keywords||[]).length) ? 'style="display:none"' : '' }></textarea>
          ${(function(){
            try{
              if (getInputMode()!=='cloze') return '';
              const kws = (p.keywords||[]);
              if (!kws.length) return '';
              const masked = buildClozeNumbered(p.example || "", kws);
              const inputs = kws.map((_,i)=>`<div class="cell"><span class="n">[${i+1}]</span><input type="text" id="cloze-${i+1}" placeholder="キーワード ${i+1}"></div>`).join('');
              return `<div class="section"><strong>穴埋め（番号）</strong><div class="cloze-card">${masked || '（模範解答が未登録です）'}</div></div>
                      <div class="section"><label>番号ごとにキーワードを入力</label><div class="cloze-inputs">${inputs}</div></div>`;
            }catch(_){ return ''; }
          })()}
          <div class="section flex">
            ${prevExists ? `<button class="ghost" onclick="app.prev()">◀ 前の問題へ</button>` : ""}
            <button class="primary" id="btn-grade" onclick="app.grade()" title="ショートカット: ⌘/Ctrl + Enter">採点する</button>
            ${nextExists ? `<button class="ghost" onclick="app.next()">次の問題へ ▶</button>` : ""}
          </div>
          <div class="small muted">ショートカット：採点 <span class="kbd">⌘</span>/<span class="kbd">Ctrl</span>+<span class="kbd">Enter</span>、前へ <span class="kbd">K</span>、次へ <span class="kbd">J</span>、自己評価 <span class="kbd">1</span>/<span class="kbd">2</span>/<span class="kbd">3</span></div>
        </div>
        <div id="result" class="section"></div>
      </div>
    `;
    startTimer();
  }

  function renderReview(){
    const dueToday = getDueTodayIds();
    const weakUnsure = state.problems.filter(p => latestSelfTag(p)==='unsure').map(p=>p.id);
    const weakFail   = state.problems.filter(p => latestSelfTag(p)==='fail').map(p=>p.id);
    
    const dueTodayJson = JSON.stringify(dueToday);
    const weakUnsureJson = JSON.stringify(weakUnsure);
    const weakFailJson = JSON.stringify(weakFail);

    const todayListHtml = state.reviewTodayListVisible ? `
      <div class="review-details-list">
        ${dueToday.length > 0 ? dueToday.map(id => {
          const p = idToProb(id);
          return `
            <div class="review-detail-item">
              <span class="timing-tag">${getReviewTimingLabel(p)}</span>
              <span class="space">${escapeHtml(p.question)}</span>
              <button class="ghost" onclick="app.startQuiz(${p.id})">解く</button>
            </div>
          `;
        }).join('') : '<p class="muted small" style="text-align: center;">今日復習する問題はありません。</p>'}
      </div>
    ` : '';

    $app.innerHTML = `
      <div class="card">
        <h2>復習</h2>
        <div class="review-tabs">
          <button class="review-tab ${state.reviewTab === 'today' ? 'active' : ''}" onclick="app.setReviewTab('today')">今日の復習</button>
          <button class="review-tab ${state.reviewTab === 'weak' ? 'active' : ''}" onclick="app.setReviewTab('weak')">弱点ドリル</button>
          <button class="review-tab ${state.reviewTab === 'custom' ? 'active' : ''}" onclick="app.setReviewTab('custom')">カスタム演習</button>
        </div>

        <div id="tab-today" class="tab-content ${state.reviewTab === 'today' ? 'active' : ''}">
          <div class="action-card primary" style="cursor: pointer;" onclick="app.toggleReviewTodayList()">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3zM3 10h18v2H3zM3 16h12v2H3z"/></svg>
            <h3 class="title">今日やる問題 (${dueToday.length}件)</h3>
            <p class="description">間隔反復に基づき、今日復習すべき問題です。クリックして一覧を表示します。</p>
            <div class="actions">
              <button class="ghost" style="background: #fff; color: var(--accent);" ${dueToday.length === 0 ? 'disabled' : ''} onclick='event.stopPropagation(); app.startQueue(${dueTodayJson}, false)'>順番に解く</button>
              <button class="ghost" style="background: #fff; color: var(--accent);" ${dueToday.length === 0 ? 'disabled' : ''} onclick='event.stopPropagation(); app.startQueue(${dueTodayJson}, true)'>ランダムで解く</button>
            </div>
          </div>
          ${todayListHtml}
        </div>

        <div id="tab-weak" class="tab-content ${state.reviewTab === 'weak' ? 'active' : ''}">
          <div class="action-card">
            <h3 class="title">弱点ドリル</h3>
            <p class="description">過去の評価に基づき、苦手な問題を重点的に復習します。</p>
            <div class="section">
              <strong>「普通」と評価した問題 (${weakUnsure.length}件)</strong>
              <div class="actions" style="margin-top: 0.5rem">
                <button class="ghost" ${weakUnsure.length === 0 ? 'disabled' : ''} onclick='app.startQueue(${weakUnsureJson}, true)'>ランダムで解く</button>
              </div>
            </div>
            <div class="section">
              <strong>「できない」と評価した問題 (${weakFail.length}件)</strong>
              <div class="actions" style="margin-top: 0.5rem">
                <button class="ghost" ${weakFail.length === 0 ? 'disabled' : ''} onclick='app.startQueue(${weakFailJson}, true)'>ランダムで解く</button>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-custom" class="tab-content ${state.reviewTab === 'custom' ? 'active' : ''}">
          <div class="action-card">
            <h3 class="title">科目横断ランダム出題</h3>
            <p class="description">全ての科目からランダムで問題を出題します。</p>
            <div class="row-sm" style="justify-content: center;">
              <label class="small">件数</label>
              <input type="number" id="randN" min="1" step="1" value="10" style="max-width:8rem">
              <label class="small">重要度</label>
              <select id="randImp">
                <option value="all">すべて</option>
                <option value="★重要">⚫︎ 重要のみ</option>
              </select>
              <button class="ghost" id="btnRandStart">開始</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    const btnRandStart = document.getElementById('btnRandStart');
    if(btnRandStart) {
      btnRandStart.onclick = ()=>{
        const n = Math.max(1, Number((document.getElementById('randN')||{}).value||10));
        const impSel = (document.getElementById('randImp')||{}).value || 'all';
        let arr = state.problems.slice();
        if (impSel !== 'all'){ arr = arr.filter(p => p.importance === impSel); }
        arr = shuffle(arr);
        const ids = arr.slice(0, n).map(p=>p.id);
        startQueue(ids, false);
      };
    }
  }
  
  function renderAdd(){
    const subjectOptions = `
      <optgroup label="必修科目">
        ${CORE_SUBJECTS.map(s=>`<option>${s}</option>`).join('')}
      </optgroup>
      <optgroup label="選択科目">
        <option value="__ELECTIVE__">選択科目</option>
      </optgroup>
    `;
    const defaultSubject = state.currentSubject || CORE_SUBJECTS[0];
    $app.innerHTML = `
      <div class="card">
        <h2>新しい問題を追加</h2>
        <div class="home-grid">
          <div>
            <label>科目</label>
            <select id="f-subject">${subjectOptions}</select>
          </div>
          <div>
            <label>重要度</label>
            <select id="f-importance">${IMPORTANCES.map(im=>`<option value="${im}">${importanceLabel(im)}</option>`).join('')}</select>
          </div>
        </div>
        <div class="section">
          <label>分野</label>
          <div id="f-topic-area"></div>
        </div>
        <div class="section">
          <label>小分類</label>
          <div id="f-subtopic-area"></div>
        </div>
        <div class="section">
          <label>問題文</label>
          <textarea id="f-question"></textarea>
        </div>
        <div class="section">
          <label>模範解答</label>
          <textarea id="f-example"></textarea>
        </div>
        <div class="section">
          <label>重要キーワード（カンマ/句点区切り・任意）</label>
          <input id="f-keywords">
        </div>
        <div class="section">
          <label>補足情報（採点には影響しないメモ）</label>
          <textarea id="f-note"></textarea>
        </div>
        <div class="section flex">
          <button class="primary" onclick="app.addSubmit()">追加する</button>
        </div>
      </div>
    `;
    const sel = document.getElementById('f-subject');
    sel.value = defaultSubject;

    function mountTopic(){
      document.getElementById('f-topic-area').innerHTML = buildTopicSelectHTML(sel.value, '');
      bindTopicHandlers();
      mountSubtopic();
    }
    function currentTopicValue(){
      const tSel = document.getElementById('f-topic');
      if (!tSel) return (document.getElementById('f-topic-new')?.value||'').trim();
      if (tSel.value === "__NEW__") return (document.getElementById('f-topic-new')?.value||'').trim();
      return tSel.value;
    }
    function mountSubtopic(){
      const topicVal = currentTopicValue();
      document.getElementById('f-subtopic-area').innerHTML = buildSubtopicSelectHTML(sel.value, topicVal, '');
      bindSubtopicHandlers();
    }
    function bindTopicHandlers(){
      const tSel = document.getElementById('f-topic');
      const tNewWrap = document.getElementById('f-topic-new-wrap');
      if (tSel){
        tSel.addEventListener('change', ()=>{
          if (tSel.value === "__NEW__"){
            if (tNewWrap) tNewWrap.classList.remove('hidden');
          }else{
            if (tNewWrap) tNewWrap.classList.add('hidden');
          }
          mountSubtopic();
        });
      }
    }
    function bindSubtopicHandlers(){
      const sSel = document.getElementById('f-subtopic');
      const sNewWrap = document.getElementById('f-subtopic-new-wrap');
      if (sSel){
        sSel.addEventListener('change', ()=>{
          if (sSel.value === "__NEW__"){
            if (sNewWrap) sNewWrap.classList.remove('hidden');
          }else{
            if (sNewWrap) sNewWrap.classList.add('hidden');
          }
        });
      }
    }

    sel.addEventListener('change', ()=>{ mountTopic(); });
    mountTopic();
  }

  function buildTopicSelectHTML(subject, currentValue){
    const topics = topicsForSubject(subject);
    if (topics.length === 0) {
      return `<input id="f-topic-new" placeholder="新しい分野名を入力（未分類可）" value="${escapeHtml(currentValue||'')}">`;
    }
    const opts = ['<option value="">（未分類）</option>']
      .concat(topics.map(t=>`<option value="${t.replace(/"/g,'&quot;')}" ${currentValue===t?'selected':''}>${t}</option>`))
      .concat([`<option value="__NEW__">（新規作成…）</option>`])
      .join('');
    return `
      <select id="f-topic">${opts}</select>
      <div class="inline ${currentValue && !topics.includes(currentValue)?'':'hidden'}" id="f-topic-new-wrap" style="margin-top: .5rem;">
        <input id="f-topic-new" placeholder="新しい分野名" value="${escapeHtml(currentValue||'')}">
      </div>`;
  }
  function buildSubtopicSelectHTML(subject, topic, currentValue){
    const subs = subtopicsFor(subject, topic);
    if (subs.length === 0) {
      return `<input id="f-subtopic-new" placeholder="新しい小分類名を入力（未分類可）" value="${escapeHtml(currentValue||'')}">`;
    }
    const opts = ['<option value="">（未分類）</option>']
      .concat(subs.map(t=>`<option value="${t.replace(/"/g,'&quot;')}" ${currentValue===t?'selected':''}>${t}</option>`))
      .concat([`<option value="__NEW__">（新規作成…）</option>`])
      .join('');
    return `
      <select id="f-subtopic">${opts}</select>
      <div class="inline ${currentValue && !subs.includes(currentValue)?'':'hidden'}" id="f-subtopic-new-wrap" style="margin-top: .5rem;">
        <input id="f-subtopic-new" placeholder="新しい小分類名" value="${escapeHtml(currentValue||'')}">
      </div>`;
  }

  function renderEdit(){
    const prob = state.problems.find(x=>x.id===state.currentProblemId);
    if (!prob){ setActive('list'); return; }
    const subjectOptions = `
      <optgroup label="必修科目">
        ${CORE_SUBJECTS.map(s=>`<option ${prob.subject===s?'selected':''}>${s}</option>`).join('')}
      </optgroup>
      <optgroup label="選択科目">
        <option value="__ELECTIVE__" ${prob.subject==='__ELECTIVE__'?'selected':''}>選択科目</option>
        ${ELECTIVE_SUBJECTS.map(s=>`<option ${prob.subject===s?'selected':''}>${s}</option>`).join('')}
      </optgroup>
    `;
    $app.innerHTML = `
      <div class="card">
        <div class="flex">
          <button class="back-to-list ghost" onclick="app.setActive('list')">← 問題一覧</button>
          <h2 style="margin:0 .5rem">問題の編集</h2>
        </div>
        <div class="home-grid section">
          <div>
            <label>科目</label>
            <select id="e-subject">${subjectOptions}</select>
          </div>
          <div>
            <label>重要度</label>
            <select id="e-importance">
              ${IMPORTANCES.map(im=>`<option value="${im}" ${prob.importance===im?'selected':''}>${importanceLabel(im)}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="section">
          <label>分野</label>
          <div id="e-topic-area"></div>
        </div>
        <div class="section">
          <label>小分類</label>
          <div id="e-subtopic-area"></div>
        </div>
        <div class="section">
          <label>問題文</label>
          <textarea id="e-question">${escapeHtml(prob.question||'')}</textarea>
        </div>
        <div class="section">
          <label>模範解答</label>
          <textarea id="e-example">${escapeHtml(prob.example||'')}</textarea>
        </div>
        <div class="section">
          <label>重要キーワード（カンマ/句点区切り・任意）</label>
          <input id="e-keywords" value="${escapeHtml((prob.keywords||[]).join('、'))}">
        </div>
        <div class="section">
          <label>補足情報（採点には影響しないメモ）</label>
          <textarea id="e-note">${escapeHtml(prob.note||'')}</textarea>
        </div>
        <div class="section flex">
          <button class="primary" onclick="app.saveEdit()">保存する</button>
          <button class="ghost danger" onclick="app.deleteProblem(${prob.id})">削除</button>
        </div>
      </div>
    `;
    const sel = document.getElementById('e-subject');
    function mountTopic(){
      document.getElementById('e-topic-area').innerHTML = buildTopicSelectEditHTML(sel.value, prob.topic||'');
      bindTopicHandlers();
      mountSubtopic();
    }
    function currentTopicValue(){
      const tSel = document.getElementById('e-topic');
      if (!tSel) return (document.getElementById('e-topic-new')?.value||'').trim();
      if (tSel.value === "__NEW__") return (document.getElementById('e-topic-new')?.value||'').trim();
      return tSel.value;
    }
    function mountSubtopic(){
      const topicVal = currentTopicValue();
      document.getElementById('e-subtopic-area').innerHTML = buildSubtopicSelectEditHTML(sel.value, topicVal, prob.subtopic||'');
      bindSubtopicHandlers();
    }
    function bindTopicHandlers(){
      const tSel = document.getElementById('e-topic');
      const tNewWrap = document.getElementById('e-topic-new-wrap');
      if (tSel){
        tSel.addEventListener('change', ()=>{
          if (tSel.value === "__NEW__"){
            if (tNewWrap) tNewWrap.classList.remove('hidden');
          }else{
            if (tNewWrap) tNewWrap.classList.add('hidden');
          }
          mountSubtopic();
        });
      }
    }
    function bindSubtopicHandlers(){
      const sSel = document.getElementById('e-subtopic');
      const sNewWrap = document.getElementById('e-subtopic-new-wrap');
      if (sSel){
        sSel.addEventListener('change', ()=>{
          if (sSel.value === "__NEW__"){
            if (sNewWrap) sNewWrap.classList.remove('hidden');
          }else{
            if (sNewWrap) sNewWrap.classList.add('hidden');
          }
        });
      }
    }
    sel.addEventListener('change', mountTopic);
    mountTopic();
  }
  
  function buildTopicSelectEditHTML(subject, currentValue){
    const topics = topicsForSubject(subject);
    if (topics.length === 0) {
      return `<input id="e-topic-new" placeholder="新しい分野名を入力（未分類可）" value="${escapeHtml(currentValue||'')}">`;
    }
    const opts = ['<option value="">（未分類）</option>']
      .concat(topics.map(t=>`<option value="${t.replace(/"/g,'&quot;')}" ${currentValue===t?'selected':''}>${t}</option>`))
      .concat([`<option value="__NEW__">（新規作成…）</option>`])
      .join('');
    const needNew = currentValue && !topics.includes(currentValue);
    return `
      <select id="e-topic">${opts}</select>
      <div class="inline ${needNew?'':'hidden'}" id="e-topic-new-wrap" style="margin-top: .5rem;">
        <input id="e-topic-new" placeholder="新しい分野名" value="${escapeHtml(currentValue||'')}">
      </div>`;
  }
  function buildSubtopicSelectEditHTML(subject, topic, currentValue){
    const subs = subtopicsFor(subject, topic);
    if (subs.length === 0) {
      return `<input id="e-subtopic-new" placeholder="新しい小分類名を入力（未分類可）" value="${escapeHtml(currentValue||'')}">`;
    }
    const opts = ['<option value="">（未分類）</option>']
      .concat(subs.map(t=>`<option value="${t.replace(/"/g,'&quot;')}" ${currentValue===t?'selected':''}>${t}</option>`))
      .concat([`<option value="__NEW__">（新規作成…）</option>`])
      .join('');
    const needNew = currentValue && !subs.includes(currentValue);
    return `
      <select id="e-subtopic">${opts}</select>
      <div class="inline ${needNew?'':'hidden'}" id="e-subtopic-new-wrap" style="margin-top: .5rem;">
        <input id="e-subtopic-new" placeholder="新しい小分類名" value="${escapeHtml(currentValue||'')}">
      </div>`;
  }
  
  function renderSettings(){
    $app.innerHTML = `
      <div class="card">
        <h2>設定 / 同期</h2>
        <h3 class="section">A. 端末ローカル保存（iPhone/PC共通）</h3>
        <div class="section">
          <label><input type="checkbox" id="cfg-local"> 端末に自動保存</label>
          <label><input type="checkbox" id="cfg-restore"> 起動時に自動復元</label>
        </div>
        <h3 class="section">B. ドリル設定</h3>
        <div class="section">
          <label>弱点ドリルの比率（普通 / できない / その他）</label>
          <div class="row-sm">
            <input type="number" id="cfg-mix-u" min="0" step="1" style="max-width:6rem">
            <input type="number" id="cfg-mix-f" min="0" step="1" style="max-width:6rem">
            <input type="number" id="cfg-mix-o" min="0" step="1" style="max-width:6rem">
          </div>
        </div>
        <div class="section row-sm">
          <button class="ghost" id="btn-save-cfg">設定を保存</button>
          <button class="ghost danger" id="btn-clear">ローカルキャッシュを消去</button>
        </div>
        <h3 class="section">C. 手動インポート/エクスポート</h3>
        <div class="section">
          <div class="row-sm">
            <input type="file" id="file" accept="application/json" />
            <button class="ghost" id="btn-import">インポート</button>
            <button class="ghost" id="btn-export">エクスポート</button>
          </div>
        </div>
      </div>
    `;
    const chkLocal   = document.getElementById('cfg-local');
    const chkRestore = document.getElementById('cfg-restore');
    chkLocal.checked = !!config.autoLocalSave;
    chkRestore.checked = !!config.autoRestore;

    const mu = document.getElementById('cfg-mix-u');
    const mf = document.getElementById('cfg-mix-f');
    const mo = document.getElementById('cfg-mix-o');
    mu.value = Number(config.mixRatio?.unsure||0);
    mf.value = Number(config.mixRatio?.fail||0);
    mo.value = Number(config.mixRatio?.other||0);

    chkLocal.onchange = e => { config.autoLocalSave = e.target.checked; };
    chkRestore.onchange = e => { config.autoRestore = e.target.checked; };

    document.getElementById('btn-save-cfg').onclick = ()=>{
      config.mixRatio = {unsure:Number(mu.value||0), fail:Number(mf.value||0), other:Number(mo.value||0)};
      saveConfig(); showToast('設定を保存しました。');
    };
    document.getElementById('btn-clear').onclick = ()=>{
      clearLocal();
      showToast("ローカルキャッシュを消去しました。");
    };
    document.getElementById('btn-import').onclick = ()=>{
      const f = document.getElementById('file').files[0];
      if (!f) { showToast("ファイルを選択してください。", "error"); return; }
      handleImportFile(f, true);
    };
    document.getElementById('btn-export').onclick = ()=>{
      doExport("problems.json");
    };
  }

  function handleImportFile(file, notify=true, after){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        sanitizeProblems(data);
        state.problems = data;
        reindex();
        saveLocal(state.problems, sessionsState.logs);
        scheduleFileSave();
        updateNavBadges();
        if (notify) showToast("インポートしました。", "success");
        setActive('subjects');
        if (after) after();
      }catch(e){ showToast("JSONの解析に失敗: " + e.message, "error"); }
    };
    reader.readAsText(file, "utf-8");
  }

  function doExport(filename){
    const blob = new Blob([JSON.stringify(state.problems, null, 2)], {type:"application/json"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename || "problems.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'toast-out 0.5s forwards';
        toast.addEventListener('animationend', () => {
            toast.remove();
        });
    }, 3000);
  }

  (async function boot(){
    try{
      let loaded = false;
      if (await tryRestoreFileHandle(true)){
        loaded = true;
      }
      if (!loaded && config.autoRestore){
        const cached = loadLocal();
        if (cached && Array.isArray(cached.problems)) {
          try {
            sanitizeProblems(cached.problems);
            state.problems = cached.problems;
            if (Array.isArray(cached.sessions)) sessionsState.logs = cached.sessions;
            loaded = true;
          } catch(e) {}
        }
      }
      if (!loaded){
        state.problems = [];
      }
      reindex();
      state.view = 'home';
      const ui = loadUI() || {};
      state.currentImportance = ui.currentImportance || 'all';
      state.currentSelf = ui.currentSelf || 'all';
      
      setActive(state.view);
      
      // Wire up nav and mode buttons
      document.querySelectorAll('#rail .nav button, #tabbar .item').forEach(el => {
        el.addEventListener('click', () => {
          const view = el.getAttribute('data-nav');
          if (view === 'exit') {
            // __exitFlow(); // Assuming this function exists for iPhone
          } else if (view) {
            setActive(view);
          }
        });
      });
      
      const mFull = document.getElementById('rail-mode-full');
      const mCloze = document.getElementById('rail-mode-cloze');
      if (mFull) mFull.addEventListener('click', () => setInputMode('full'));
      if (mCloze) mCloze.addEventListener('click', () => setInputMode('cloze'));
      updateInputModeUI();

    }catch(e){ showError(e); }
  })();

  // Expose functions to global scope for onclick handlers
  return {
    setActive,
    selectSubject: (s)=>{ state.currentSubject = s; state.currentTopic='all'; state.currentSubtopic='all'; setActive('topics'); },
    selectElective: ()=>{ state.currentSubject = ELECTIVE_GROUP; state.currentTopic='all'; state.currentSubtopic='all'; setActive('topics'); },
    selectTopic: (t)=>{ state.currentTopic = t; state.currentSubtopic = 'all'; setActive((t==='all') ? 'list' : 'subtopics'); },
    startSubjectAll: (rnd)=>{ let ids = idsBySubject(state.currentSubject); const n = getSubjectCount(); ids = pickWithLimit(ids, n, rnd); startQueue(ids, false); },
    startTopic: (topic, rnd)=>{ let ids = idsByTopic(state.currentSubject, topic); const n = getSubjectCount(); ids = pickWithLimit(ids, n, rnd); startQueue(ids, false); },
    selectSubtopic: (st)=>{ state.currentSubtopic = st; setActive('list'); },
    startTopicAll: (rnd)=>{ let ids = idsByTopic(state.currentSubject, state.currentTopic); const n = getSubjectCount(); ids = pickWithLimit(ids, n, rnd); startQueue(ids, false); },
    startSubtopic: (st, rnd)=>{ let ids = idsBySubtopic(state.currentSubject, state.currentTopic, st); const n = getSubjectCount(); ids = pickWithLimit(ids, n, rnd); startQueue(ids, false); },
    startAll: (rnd)=>{ let base = filtered().map(p=>p.id); const n = getSubjectCount(); const chosen = pickWithLimit(base, n, rnd); startQueue(chosen, false); },
    startQuiz: (id)=>{ state.reviewQueue=null; state.currentProblemId = id; startSession([id], false); setActive('quiz'); },
    editProblem: (id)=>{ state.currentProblemId = id; setActive('edit'); },
    deleteProblem: (id)=>{ const target = state.problems.find(p=>p.id===id); if (!target) return; if (confirm(`次の問題を削除します。よろしいですか？\n\n「${target.question}」`)) { state.problems = state.problems.filter(p=>p.id!==id); reindex(); saveLocal(state.problems, sessionsState.logs); scheduleFileSave(); updateNavBadges(); render(); } },
    prev: ()=>{ const id=navPrevId(); if (id){ state.currentProblemId=id; renderQuiz(); } },
    next: ()=>{ const id=navNextId(); if (id){ state.currentProblemId=id; renderQuiz(); } else { const resultEl = document.getElementById('result'); if(resultEl) { resultEl.innerHTML = `<div class="card"><div class="muted">キュー内の問題を解き終えました。</div><div class="section flex"><button class="ghost" onclick="app.goHome()">トップへ戻る</button><button class="ghost" onclick="app.setActive('review')">復習ダッシュボードに戻る</button></div></div>`; endSession(); stopTimer(); } } },
    grade: ()=>{ const elapsed = state.timerStart ? Math.round((Date.now()-state.timerStart)/1000) : null; let txt = (document.getElementById('answer').value || '').trim(); const prob = state.problems.find(x=>x.id===state.currentProblemId); const __mode = (typeof getInputMode==='function') ? getInputMode() : 'full'; if (__mode==='cloze' && prob && Array.isArray(prob.keywords) && prob.keywords.length){ const parts = []; for (let i=1;i<=prob.keywords.length;i++){ const el = document.getElementById('cloze-'+i); parts.push(el ? String(el.value||'').trim() : ''); } txt = parts.join(' '); } const total = (prob.keywords||[]).length; let matches=[], missing=[]; function __norm(s){ try{ s = String(s||'').normalize('NFKC'); }catch(_){ s = String(s||''); } s = s.replace(/\s+/g,' ').trim().replace(/[、，]/g,',').replace(/[。．]/g,'.').toLowerCase(); return s; } if (__mode==='cloze' && total>0){ const parts = []; for (let i=1;i<=total;i++){ const el = document.getElementById('cloze-'+i); parts.push(el ? (el.value||'') : ''); } for (let i=0;i<total;i++){ if (__norm(parts[i]) === __norm(prob.keywords[i])) matches.push(prob.keywords[i]); else missing.push(prob.keywords[i]); } }else{ const nTxt = __norm(txt); matches = (prob.keywords||[]).filter(kw => nTxt.includes(__norm(kw))); missing = (prob.keywords||[]).filter(kw => !nTxt.includes(__norm(kw))); } let score="✕", cls="score-bad", scoreDetail=""; if (total===0){ score="—"; cls=""; scoreDetail="（キーワード未設定のため採点なし）"; }else{ const ratio = matches.length / total; if (ratio===1){ score="◎"; cls="score-okay"; } else if (ratio>=0.6){ score="○"; cls="score-mid"; } else if (ratio>0){ score="△"; cls="score-low"; } else { score="✕"; cls="score-bad"; } scoreDetail = `（${matches.length} / ${total}）`; } const t = todayStr(); const nextByScore = (()=>{ if (score==="◎") return [7,14,30]; if (score==="○") return [3,7,14,30]; if (score==="△") return [1,3,7,14]; if (score==="✕") return [1,3]; return [1,3,7,14,30]; })().map(addDaysLocal); prob.reviews = (prob.reviews || []).filter(d=>d>t); const set = new Set([...(prob.reviews||[]), ...nextByScore]); prob.reviews = Array.from(set).sort(); prob.history.push({date:new Date().toISOString(), score, hit:matches.length, total:total, secs: elapsed, self:null}); try { const mode = (sessionsState.current && sessionsState.current.context && sessionsState.current.context.mode) || null; if (mode === 'weak' && score === '◎') { prob.weakPoints = Math.max(0, (prob.weakPoints||0) - 3); } } catch(_) {} bumpSessionOnScore(score); addDailyAnswered(1); saveLocal(state.problems, sessionsState.logs); scheduleFileSave(); updateNavBadges(); function escReg(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); } let escaped = escapeHtml(txt); matches.forEach(kw=>{ const re = new RegExp(escReg(kw), 'g'); escaped = escaped.replace(re, `<mark class="hit">${kw}</mark>`); }); let modelEscaped = escapeHtml(prob.example || "（登録なし）"); (prob.keywords || []).forEach(kw=>{ if (!kw) return; const re = new RegExp(escReg(kw), 'g'); const has = matches.includes(kw); modelEscaped = modelEscaped.replace(re, `<mark class="${has?'hit':'miss'}">${kw}</mark>`); }); const currentSel = (()=>{ for(let i=prob.history.length-1;i>=0;i--){ if (prob.history[i].self) return prob.history[i].self; } return null; })(); document.getElementById('result').innerHTML = ` <div class="card"> <div>評価：<span class="score ${cls}">${score}</span> ${scoreDetail} ${elapsed!=null? `<span class="muted small">（所要 ${Math.floor(elapsed/60)}分${elapsed%60}秒）</span>`:''}</div> <div class="muted section">${ total===0 ? "（キーワード未設定）" : `含まれていたキーワード：${matches.length? matches.map(k=>`<span class='kw'>${k}</span>`).join(' ') : "なし"}` }</div> ${ total>0 ? `<div class="section"><strong>抜けていたキーワード</strong><div>${missing.length? missing.map(k=>`<span class='kw kw-miss'>${k}</span>`).join(' ') : "なし"}</div></div>` : ""} <div class="section"> <label>あなたの回答（命中キーワードをハイライト）</label> <div style="white-space:pre-line;border:1px dashed #ccc;border-radius:.6rem;padding:.6rem;background:#fcfcfc">${escaped || "（未入力）"}</div> </div> <div class="section"> <strong>模範解答（命中=黄／抜け=桃）</strong> <div style="white-space:pre-line;border:1px solid #dbeafe;background:#eff6ff;border-radius:.6rem;padding:.6rem">${modelEscaped}</div> </div> ${prob.note ? `<div class="section"><strong>補足情報</strong><div class="note">${escapeHtml(prob.note)}</div></div>` : ""} <div class="section"> <strong>自己評価：</strong> <div class="flex" id="selfBtns" style="margin-top:.5rem"> <button class="ghost selfbtn ${currentSel==='perfect'?'active':''}" data-tag="perfect" onclick="app.selfMark('perfect')">できた</button> <button class="ghost selfbtn ${currentSel==='unsure'?'active':''}" data-tag="unsure" onclick="app.selfMark('unsure')">普通</button> <button class="ghost selfbtn ${currentSel==='fail'?'active':''}" data-tag="fail" onclick="app.selfMark('fail')">できない</button> </div> </div> <div class="section flex"> <button class="ghost" onclick="app.goHome()">トップへ戻る</button> ${!!navPrevId() ? `<button class="ghost" onclick="app.prev()">◀ 前の問題へ</button>` : ''} ${!!navNextId() ? `<button class="primary" onclick="app.next()">次の問題へ ▶</button>` : '<span class="muted">（キューの最後です）</span>'} </div> </div> `; },
    selfMark: (tag)=>{ const prob = state.problems.find(x=>x.id===state.currentProblemId); const last = prob.history[prob.history.length-1]; if (last) last.self = tag; prob.selfStats = prob.selfStats || {perfect:0,unsure:0,fail:0}; if (tag==='perfect') prob.selfStats.perfect++; if (tag==='unsure') { prob.selfStats.unsure++; prob.weakPoints = Math.max(0, (prob.weakPoints||0) + 2); } if (tag==='fail')   { prob.selfStats.fail++;   prob.weakPoints = Math.max(0, (prob.weakPoints||0) + 3); } saveLocal(state.problems, sessionsState.logs); scheduleFileSave(); updateNavBadges(); document.querySelectorAll('.selfbtn').forEach(b=> b.classList.remove('active')); const target = Array.from(document.querySelectorAll('.selfbtn')).find(b=> b.getAttribute('data-tag')===tag); if (target) target.classList.add('active'); },
    goHome: ()=> { endSession(); stopTimer(); setActive('home'); },
    setReviewTab: (tabName) => { state.reviewTab = tabName; state.reviewTodayListVisible = false; renderReview(); },
    toggleReviewTodayList: () => { state.reviewTodayListVisible = !state.reviewTodayListVisible; renderReview(); },
    startQueue: (ids, rnd)=> startQueue(ids, rnd),
    addSubmit: ()=>{ const subject = document.getElementById('f-subject').value; let topic = ''; const tSel = document.getElementById('f-topic'); if (tSel) { topic = (tSel.value === "__NEW__") ? (document.getElementById('f-topic-new').value || '').trim() : tSel.value; } else { topic = (document.getElementById('f-topic-new').value || '').trim(); } let subtopic = ''; const sSel = document.getElementById('f-subtopic'); if (sSel) { subtopic = (sSel.value === "__NEW__") ? (document.getElementById('f-subtopic-new').value || '').trim() : sSel.value; } else { subtopic = (document.getElementById('f-subtopic-new').value || '').trim(); } const importance = document.getElementById('f-importance').value; const question = (document.getElementById('f-question').value||'').trim(); const example  = (document.getElementById('f-example').value||'').trim(); const keywordsRaw = (document.getElementById('f-keywords').value||''); const keywords = keywordsRaw ? keywordsRaw.split(KEY_SPLIT).map(s=>s.trim()).filter(Boolean) : []; const note     = (document.getElementById('f-note').value||'').trim(); if (!question) { showToast('問題文を入力してください。', 'error'); return; } state.problems.push({ id: Date.now()+Math.floor(Math.random()*1000), subject, topic, subtopic, importance, question, example, keywords, note, history:[], reviews:[], selfStats:{perfect:0,unsure:0,fail:0} }); reindex(); saveLocal(state.problems, sessionsState.logs); scheduleFileSave(); updateNavBadges(); document.getElementById('f-question').value=''; document.getElementById('f-example').value=''; document.getElementById('f-keywords').value=''; document.getElementById('f-note').value=''; showToast('問題を追加しました。', 'success'); },
    saveEdit: ()=>{ const prob = state.problems.find(x=>x.id===state.currentProblemId); const subject = document.getElementById('e-subject').value; let topic = ''; const tSel = document.getElementById('e-topic'); if (tSel) { topic = (tSel.value === "__NEW__") ? (document.getElementById('e-topic-new').value || '').trim() : tSel.value; } else { topic = (document.getElementById('e-topic-new').value || '').trim(); } let subtopic = ''; const sSel = document.getElementById('e-subtopic'); if (sSel) { subtopic = (sSel.value === "__NEW__") ? (document.getElementById('e-subtopic-new').value || '').trim() : sSel.value; } else { subtopic = (document.getElementById('e-subtopic-new').value || '').trim(); } const importance = document.getElementById('e-importance').value; const question = (document.getElementById('e-question').value||'').trim(); const example  = (document.getElementById('e-example').value||'').trim(); const keywordsRaw = (document.getElementById('e-keywords').value||''); const keywords = keywordsRaw ? keywordsRaw.split(KEY_SPLIT).map(s=>s.trim()).filter(Boolean) : []; const note     = (document.getElementById('e-note').value||'').trim(); if (!question) { showToast('問題文を入力してください。', 'error'); return; } Object.assign(prob, {subject, topic, subtopic, importance, question, example, keywords, note}); reindex(); saveLocal(state.problems, sessionsState.logs); scheduleFileSave(); updateNavBadges(); showToast('保存しました。', 'success'); },
    setImp: (v)=>{ state.currentImportance=v; render(); },
    setSelf: (v)=>{ state.currentSelf=v; render(); },
    resetFilters: ()=>{ state.currentImportance='all'; state.currentSelf='all'; render(); }
  };
})();
</script>
</body>
</html>
